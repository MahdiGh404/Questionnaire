<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>نمایش کامل پرسشنامه‌ها</title>

  <!-- Bootstrap RTL -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css">

  <!-- DataTables + Bootstrap 5 -->
  <link rel="stylesheet"
        href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">

  <!-- قلم فارسی -->
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap"
        rel="stylesheet">

  <style>
    body      {font-family:'Vazirmatn',Tahoma,sans-serif;background:#f8f9fa}
    th,td     {vertical-align:top;font-size:.85rem}
    /* رنگ‌بندی سطوح تو در تو */
    .lvl-0{padding-right:.2rem}
    .lvl-1{padding-right:1.5rem;background:#fdfdfd}
    .lvl-2{padding-right:3rem; background:#fafafa}
    .lvl-3{padding-right:4.5rem;background:#f7f7f7}
    .lvl-4{padding-right:6rem; background:#f4f4f4}
    .section-row      {background:#dfe7ff;font-weight:600}
    .array-item-title {background:#eaf0ff}
    /* DataTables حذف خطوط اضافی */
    table.dataTable>tbody>tr.section-row>td,
    table.dataTable>tbody>tr.array-item-title>td{ border-bottom-width:0;}
  </style>
</head>

<body class="container py-4">

<h1 class="text-center mb-4">نمایش کامل اطلاعات پرسشنامه‌ها</h1>

<div class="accordion" id="accordionQuestionnaires">

  <% /* ================= واژه‌نامهٔ جامع فارسی ================= */ %>
  <% const dict = {
    /* --- داده‌های پایه --- */
    _id:'شناسه', createdAt:'تاریخ ایجاد', updatedAt:'به‌روزرسانی', __v:'نسخه',
    sourceQuestionnaireId:'شناسهٔ منبع', metadata:'اطلاعات متادیتا',
    entryDate:'تاریخ ورود', enteredBy:'واردکننده',

    /* --- generalInfo --- */
    generalInfo:'اطلاعات کلی', neighborhood:'محله', basijResistanceBase:'پایگاه بسیج',
    city:'شهر', county:'شهرستان', province:'استان',

    /* Q1-Q2 */
    q1_aerialMapProvided:'نقشهٔ هوایی', q2_neighborhoodDetails:'جزئیات محله',
    oldName:'نام قدیمی', newName:'نام جدید', detail:'توضیحات',

    /* --- جمعیت --- */
    q3_population_structured:'جمعیت', totalPopulation:'جمعیت کل',
    residentHouseholds:'خانوارهای مقیم', iranian:'ایرانی', foreign:'اتباع',
    populationBreakdown:'ترکیب جمعیت',
    iranianMen:'مردان ایرانی', iranianWomen:'زنان ایرانی',
    foreignNationals:'اتباع خارجی', minorities:'اقلیت‌ها',
    ageBreakdown:'تفکیک سنی', group:'گروه', female:'زن', male:'مرد',

    /* --- مذهب --- */
    q4_religion:'اطلاعات مذهبی', distribution:'ترکیب مذهبی',
    religion:'مذهب', percentage:'درصد/تعداد',
    deviantSectsInfo_structured:'فرقه‌های انحرافی (جزئی)',
    sectName:'نام فرقه', secNumber:'تعداد پیروان', secInfo:'توضیحات',
    deviantSectsInfo_text:'متن فرقه‌های انحرافی',

    /* --- قومیت --- */
    q5_ethnicities_list:'قومیت‌ها', ethnicity:'قومیت', householdCount:'تعداد خانوار',

    /* --- موقعیت و جهت --- */
    q6_locationType:'نوع موقعیت محله', q7_direction:'جهت جغرافیایی',

    /* --- مرزها --- */
    q8_boundaries_structured:'مرزهای محله', north:'مرز شمالی', south:'مرز جنوبی',
    east:'مرز شرقی', west:'مرز غربی', q8_boundaries_text:'مرز (متن)',

    /* --- کالبدی --- */
    q9_physicalCondition:'وضعیت کالبدی', description:'شرح', percentage:'درصد/تعداد',

    /* --- امکانات --- */
    q10_facilities:'امکانات', mosque:'مسجد', hosseinieh:'حسینیه',
    school:'مدرسه', clinicOrHealthHouse:'درمانگاه/خانهٔ بهداشت',
    pharmacy:'داروخانه', sportsFieldOrGym:'زمین/سالن ورزشی',
    localPark:'پارک محلی', scholarsHouse:'خانهٔ عالم',
    pipedWaterNetwork:'شبکه آب', streetLighting:'روشنایی معابر',
    parkLighting:'روشنایی پارک', publicTransport:'حمل‌ونقل عمومی',
    cityGasNetwork:'گاز شهری', curbs:'جدول‌بندی', streetAsphalt:'آسفالت معابر',
    policeStation:'پلیس/کلانتری', basijPatrols:'گشت بسیج',
    sewageSystem:'فاضلاب', wasteCollection:'جمع‌آوری زباله',
    unusedLand:'اراضی بایر', library:'کتابخانه', cityCameras:'دوربین شهری',
    charityInstitution:'مؤسسه خیریه', nearbyShoppingCenters:'مراکز خرید نزدیک',
    counselingCenter:'مرکز مشاوره', karamatHQOffice:'دفتر قرارگاه کرامت',

    /* --- Q11-13 --- */
    q11_hasCrypts:'وجود گورستان/قبرستان تاریخی', q12_hasMountainsValleys:'وجود ارتفاعات-دره',
    q13_hasQanatsWells:'وجود قنات/چاه',

    /* --- وضعیت ملکی --- */
    propertyStatus:'وضعیت ملکی', status:'وضعیت',

    /* --- نیازمندان --- */
    q14_needyInfo:'اطلاعات نیازمندان',
    familiesNeedingAidPackages:'خانوار نیازمند بسته معیشتی',
    familiesNeedingBillPayments:'خانوار نیازمند پرداخت قبوض',
    familiesWithAddictedHead:'خانوار با سرپرست معتاد',
    needyPatientsWithSpecialNeeds:'بیماران خاص نیازمند',
    disabledResidents:'ساکنان معلول', elderlyNeedingAid:'سالمندان نیازمند',
    male:'مرد', female:'زن',
    elderlyFemaleHeadedHouseholds:'خانوار سالمندِ زن-سرپرست',
    nonElderlyFemaleHeadedHouseholdsNoJob:'خانوار زن-سرپرست بدون شغل',
    totalFemaleHeadedHouseholds:'مجموع خانوارهای زن-سرپرست',

    /* --- امنیت --- */
    q15_securityInfo:'وضعیت امنیتی', feelingOfInsecurity:'احساس ناامنی',
    worryAboutBurglars:'نگرانی از سرقت', worryAboutMuggingOrStrayDogs:'نگرانی از کیف‌قاپی/سگ‌های ولگرد',
    streetBrawls:'نزاع خیابانی', worryAboutFamilyVulnerability:'آسیب‌پذیری خانواده',
    thugsHangout:'پاتوق اوباش', peopleMovingOut:'مهاجرت ساکنان',

    /* --- اعتیاد --- */
    q16_addictionInfo:'وضعیت اعتیاد',
    familiesAffectedByAddiction:'خانوار درگیر اعتیاد',
    nonPublicAddictsInfo:'معتادان غیرمتجاهر', publicAddictsInfo:'معتادان متجاهر',
    drugDistributorCount:'تعداد توزیع‌کنندگان مواد', alcoholDistributorCount:'تعداد توزیع‌کنندگان الکل',
    distributionHotspotCount:'نقاط داغ توزیع', rehabCampExists:'کمپ ترک اعتیاد',

    /* --- مذهبی-فرهنگی --- */
    q17_religiousCulturalInfo:'وضعیت فرهنگی-مذهبی',
    religiousGroupsCount:'تعداد هیئت/گروه مذهبی',
    homeBasedReligiousCeremonies:'مراسم خانگی', congregationalPrayersAttendees:'مشارکت در نماز جماعت',
    residentClericsCount:'روحانیون ساکن', largeScaleCelebrationsMourning:'مراسم بزرگ',
    activeClericsCount:'روحانی فعال', activeMaddahsCount:'مداح فعال',
    activeFemaleSessionLeadersCount:'مدیر جلسات خواهران', participationInRalliesElections:'مشارکت در راهپیمایی/انتخابات',
    martyrsCount:'تعداد شهدا', residentMartyrFamiliesInfo:'خانواده شهدا',
    veteransCount:'جانبازان', isargaranCount:'ایثارگران', freedPowCount:'آزادگان',
    hijabObservancePercentage:'رعایت حجاب',

    /* --- آسیب‌های اجتماعی --- */
    socialHarms:'آسیب‌های اجتماعی', harmTitle:'عنوان آسیب',
    statusOrStats:'وضعیت/آمار', priority:'اولویت',

    /* --- معتمدان --- */
    q19_trustedIndividuals:'معتمدان محله', row:'ردیف', name:'نام',
    job:'شغل', phoneNumber:'تلفن', hasContact:'ارتباط دارد؟', contactFrequency:'تناوب ارتباط',

    /* --- آداب و رسوم --- */
    q20_customs:'آداب و رسوم', partA:'بخش A', partB:'بخش B',

    /* --- ظرفیت‌ها --- */
    q21_neighborhoodCapacities:'ظرفیت‌های محله', capacity:'ظرفیت', description:'توضیح',

    /* --- مساجد --- */
    q22_mosques:'مساجد', prayersHeld:'نمازهای برگزارشده',
    clericInfo:'اطلاعات روحانی', boardChairmanInfo:'هیئت امناء',
    charityAffiliation:'وابستگی خیریه', culturalCenterAffiliation:'وابستگی کانون',
    basijBaseAffiliation:'وابستگی پایگاه بسیج', publicTurnout:'حضور مردمی',
    buildingCondition:'وضع ساختمانی', cooperationWithCouncil:'همکاری با شورا',

    /* --- پایگاه‌های بسیج --- */
    q23_basijBases:'پایگاه‌های بسیج', gender:'جنسیت', commanderInfo:'فرمانده',
    commanderPhone:'تلفن فرمانده', isResident:'ساکن است؟',
    activityLevel:'سطح فعالیت', locatedInMosque:'مستقر در مسجد؟',

    /* --- مدارس --- */
    q24_schools:'مدارس', principalInfo:'مدیر', principalPhone:'تلفن مدیر',
    students:'دانش‌آموزان', boys:'پسر', girls:'دختر', total:'جمع',
    studentMaritalStatusGender:'وضعیت تأهل/جنس', address:'آدرس', cooperationLevel:'سطح همکاری',

    /* --- وضعیت تحصیلی --- */
    q25_educationalStatus_structured:'وضعیت تحصیلی', studying:'در حال تحصیل',
    graduated:'فارغ‌التحصیل',

    /* --- مراکز فرهنگی --- */
    q26_culturalCenters_list:'مراکز فرهنگی', manager:'مدیر', mobile:'موبایل', phone:'تلفن', specialty:'تخصص', cooperation:'همکاری',

    /* --- اماکن قابل بهره‌برداری --- */
    q27_places_list:'اماکن قابل بهره‌برداری', field:'عرصه', usage:'کاربری',
    q27_capacity_object:'ظرفیت فارغ‌التحصیلان', capacityExists:'ظرفیت موجود', capacityUsage:'نحوه بهره‌برداری',

    /* --- پروژه‌ها --- */
    q28_ongoingProjects_list:'پروژه‌های در حال اجرا',
    q29_unfinishedProjects_list:'پروژه‌های نیمه‌تمام',
    q30_neededProjects_list:'پروژه‌های موردنیاز',
    projectName:'نام پروژه', responsibleBody:'مسئول',

    /* --- کارگروه --- */
    q31_workgroups:'کارگروه‌ها', workgroupName:'نام کارگروه',
    responsiblePerson:'مسئول', phoneNumber:'تلفن', hasDecree:'ابلاغ دارد؟',
    isBasiji:'بسیجی است؟',

    /* --- مسائل محله --- */
    q32_issues_list_v1:'مسائل/محرومیت‌ها', title:'عنوان', level:'سطح',

    /* --- تفاهم‌نامه --- */
    q33_agreements_list:'تفاهم‌نامه‌ها', organization:'سازمان', field:'حوزه',
    agreementSubject:'موضوع',

    /* --- تحلیل محله --- */
    q34_analysis_list:'تحلیل محله', strengths:'نقاط قوت',
    weaknesses:'نقاط ضعف', capacities:'ظرفیت‌ها',
    implementationSuggestion:'پیشنهاد اجرا', needs:'نیازها',
    prerequisites:'پیش‌نیازها',

    /* --- مراکز دسترسی --- */
    q35_centers_list:'مراکز دسترسی', centerName:'نام مرکز', utilization:'میزان بهره‌برداری',

    /* --- نقاط چالشی --- */
    q36_points_list:'نقاط چالشی', location:'مکان', challengeType:'نوع چالش',

    /* --- زمین‌های بایر --- */
    q37_wasteland_list:'زمین‌های بایر', owner:'مالک', harmType:'نوع آسیب',

    /* --- اصناف --- */
    q38_guilds_list:'اصناف/مشاغل', guildType:'نوع صنف',

    /* --- کارگاه‌های اشتغال --- */
    q39_workshops_list:'کارگاه‌های اشتغال', workshopType:'نوع کارگاه',
    employeeCount:'تعداد شاغل', activityType:'نوع فعالیت',

    /* --- مشکلات اداری --- */
    q40_administrativeProblems:'مشکلات اداری/شرح کلی'
  }; const T = k => dict[k]||k; %>

  <% /* ============ تابع بازگشتی نمایش ============ */ %>
  <% function renderKV(key,val,level){
       const pad='lvl-'+level;
       /* --- مقادیر پایه‌ای --- */
       if(val===null||val===undefined||
         typeof val==='string'||typeof val==='number'||typeof val==='boolean'){ %>
         <tr><td class="<%=pad%>"><%= T(key) %></td>
             <td><%= (val===null||val===undefined||val==='')?'—':val %></td></tr><%
         return; }

       /* --- آرایه --- */
       if(Array.isArray(val)){ %>
         <tr class="section-row">
           <td class="<%=pad%>" colspan="2">■ <%= T(key) %> (آرایه – <%= val.length %> مورد)</td>
         </tr><%
         val.forEach((item,idx)=>{
           const itemTitle=`${T(key)} ${idx+1}`;
           if(item!==null && typeof item==='object' && !Array.isArray(item)){ %>
             <tr class="array-item-title">
               <td class="<%=pad%>"><%= itemTitle %></td><td></td></tr><%
             Object.entries(item).forEach(([k,v])=> renderKV(k,v,level+1));
           } else {
             renderKV(itemTitle,item,level+1);
           }
         }); return;
       }

       /* --- شیء --- */
     %><tr class="section-row">
         <td class="<%=pad%>" colspan="2">■ <%= T(key) %></td></tr><%
       Object.entries(val).forEach(([k,v])=> renderKV(k,v,level+1));
  } %>

  <% /* ========= حلقهٔ اصلی پرسشنامه‌ها ========= */ %>
  <% questionnaires.forEach((q,i)=>{ %>
    <div class="accordion-item mb-3 shadow-sm rounded-3">
      <h2 class="accordion-header" id="h<%=i%>">
        <button class="accordion-button collapsed" type="button"
                data-bs-toggle="collapse" data-bs-target="#c<%=i%>">
          محله: <strong class="px-1"><%= q.generalInfo?.neighborhood||'?' %></strong>
          — شهر: <%= q.generalInfo?.city||'?' %> — استان: <%= q.generalInfo?.province||'?' %>
          (ثبت: <%= new Date(q.createdAt).toLocaleDateString('fa-IR') %>)
        </button>
      </h2>

      <div id="c<%=i%>" class="accordion-collapse collapse">
        <div class="accordion-body">

          <!-- سرچ اختصاصی همین جدول -->
          <input type="text" class="form-control mb-3 table-search"
                 placeholder="جستجو در این پرسشنامه…">

          <table id="tbl<%=i%>"
                 class="table table-sm table-striped table-bordered datatable w-100">
            <thead class="table-dark">
              <tr><th style="width:35%">کلید</th><th>مقدار</th></tr>
            </thead>
            <tbody>
              <tr><td class="lvl-0">شناسه</td><td><%= q._id %></td></tr>
              <% Object.entries(q).forEach(([k,v])=>{
                   if(k!=='_id' && k!=='__v') renderKV(k,v,0);
                 });
              %>
            </tbody>
          </table>

        </div>
      </div>
    </div>
  <% }) %>

</div>

<!-- ===== اسکریپت‌ها ===== -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

<script>
$(function(){
  $('.datatable').each(function(){
    const $table = $(this);
    // راه‌اندازی DataTables
    const dt = $table.DataTable({
      paging:false, info:false,
      language:{search:'جستجو:', zeroRecords:'هیچ موردی یافت نشد'},
      ordering:true,
      columnDefs:[{orderable:false, targets:[0]}] // ستون کلید مرتب‌ناپذیر
    });
    // اینپوت سرچ شخصی
    $table.closest('.accordion-body').find('.table-search')
      .on('keyup', function(){ dt.search(this.value).draw(); });
  });
});
</script>
</body>
</html>
